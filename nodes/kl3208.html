<script type="text/javascript">
(function(){
  // Options shown per-channel
  const sensorOptions = [
    {v:"NTC10K20K", t:"NTC10K/20K (−40…125°C)"},
    {v:"PT1000",    t:"PT1000 (−50…200°C)"},
    {v:"PT100",     t:"PT100  (−200…850°C)"},
    {v:"CUSTOM",    t:"Custom (set min/max °C)"}
  ];

  function sensorSelect(id){
    return `
      <select id="${id}" class="kl3208-sel">
        ${sensorOptions.map(o => `<option value="${o.v}">${o.t}</option>`).join("")}
      </select>
    `;
  }

  function customRow(i){
    return `
      <div class="form-row kl3208-custom kl3208-custom-${i}" style="display:none">
        <label>Custom min/max</label>
        <div class="kl3208-vstack">
          <input type="number" id="node-input-s${i}min" step="0.1" placeholder="min °C">
          <input type="number" id="node-input-s${i}max" step="0.1" placeholder="max °C">
        </div>
      </div>
    `;
  }


  // Toggle custom fields visibility for a channel
  function toggleCustom(i){
    const val = $("#node-input-s"+i).val();
    const show = (val === "CUSTOM");
    $(".kl3208-custom-"+i).toggle(show);
  }

  RED.nodes.registerType('KL3208',{
    category: 'Beckhoff',
    color: '#ffe9c6',
    icon: 'font-awesome/fa-thermometer-half',
    paletteLabel: 'KL3208',
    defaults: {
      name:       { value: "" },
      startIndex: { value: 1,  validate: RED.validators.number() },
      step:       { value: 2,  validate: RED.validators.number() },
      units:      { value: "C" },  // "C" or "F"

      // Per-channel sensor + optional custom min/max °C overrides
      s1:{value:"NTC10K20K"}, s1min:{value:""}, s1max:{value:""},
      s2:{value:"NTC10K20K"}, s2min:{value:""}, s2max:{value:""},
      s3:{value:"NTC10K20K"}, s3min:{value:""}, s3max:{value:""},
      s4:{value:"NTC10K20K"}, s4min:{value:""}, s4max:{value:""},
      s5:{value:"NTC10K20K"}, s5min:{value:""}, s5max:{value:""},
      s6:{value:"NTC10K20K"}, s6min:{value:""}, s6max:{value:""},
      s7:{value:"NTC10K20K"}, s7min:{value:""}, s7max:{value:""},
      s8:{value:"NTC10K20K"}, s8min:{value:""}, s8max:{value:""}
    },
    inputs: 1,
    outputs: 8,
    outputLabels: function(i){ return "Ch " + (i+1); },
    label: function(){ return this.name || "KL3208"; },

    oneditprepare: function(){
      // Build channel rows now (dialog DOM exists)
      const $wrap = $("#kl3208-sensors").empty();
      for (let i=1;i<=8;i++){
        $wrap.append(
          `<div class="form-row">
             <label>Channel ${i} </label>
             ${sensorSelect("node-input-s"+i)}
           </div>` + customRow(i)
        );
      }

      // Restore saved values
      $("#node-input-units").val(this.units || "C");
      $("#node-input-startIndex").val(this.startIndex != null ? this.startIndex : 1);
      $("#node-input-step").val(this.step != null ? this.step : 2);

      for (let i=1;i<=8;i++){
        $("#node-input-s"+i).val(this["s"+i] || "NTC10K20K");
        if (this["s"+i+"min"] !== undefined) $("#node-input-s"+i+"min").val(this["s"+i+"min"]);
        if (this["s"+i+"max"] !== undefined) $("#node-input-s"+i+"max").val(this["s"+i+"max"]);
        toggleCustom(i); // show/hide according to current selection
      }

      // Wire change events to toggle custom rows live
      $(".kl3208-sel").on("change", function(){
        const id = $(this).attr("id"); // node-input-sX
        const i = parseInt(id.replace("node-input-s",""),10);
        toggleCustom(i);
      });
    }
  });
})();
</script>

<style>
  /* Vertical stack for min/max with consistent alignment */
  .kl3208-vstack{
    display: flex;
    flex-direction: column;
    gap: 8px;              /* spacing between min and max */
    width: 100%;
  }
  .kl3208-vstack input{
    width: 100%;          /* make inputs fill the right-hand column */
    box-sizing: border-box;
  }
</style>

<!-- Edit dialog -->
<script type="text/x-red" data-template-name="KL3208">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="KL3208 AI (8× temp)">
  </div>

  <div class="form-row">
    <label for="node-input-startIndex"><i class="fa fa-list-ol"></i> Start index</label>
    <input type="number" id="node-input-startIndex" min="0" step="1" placeholder="1">
  </div>
  <div class="form-row">
    <label for="node-input-step"><i class="fa fa-step-forward"></i> Step</label>
    <input type="number" id="node-input-step" min="1" step="1" placeholder="2">
  </div>

  <div class="form-row">
    <label for="node-input-units"><i class="fa fa-thermometer-half"></i> Units</label>
    <select id="node-input-units">
      <option value="C">Celsius (°C)</option>
      <option value="F">Fahrenheit (°F)</option>
    </select>
  </div>

  <hr/>
  <div id="kl3208-sensors"></div>
</script>

<!-- Help text -->
<script type="text/x-red" data-help-name="KL3208">
  <p><b>KL3208</b> — 8-channel resistance sensor input (temperature).</p>
  <ul>
    <li><b>Input:</b> Modbus array (or <code>{data:[…]}</code>) with interleaved words. Use <b>Start index</b> and <b>Step</b> (e.g., 1,3,5,7,9,11,13,15).</li>
    <li><b>Per channel:</b> choose sensor (<code>NTC10K/20K</code>, <code>PT1000</code>, <code>PT100</code>, or <code>CUSTOM</code>). Custom min/max appears only when <code>CUSTOM</code> is selected.</li>
    <li>Raw words are signed 16-bit centi-°C. The node converts to °C and °F and applies range checks.</li>
  </ul>
  <p><b>Output (per channel)</b>: <code>{ temp, units, tempC, tempF, rawUnsigned, rawSignedCenti, sensor, rangeC:{minC,maxC}, rangeF:{minF,maxF}, state }</code>.</p>
</script>
