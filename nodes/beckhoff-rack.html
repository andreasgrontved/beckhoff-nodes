<script type="text/javascript">
(function(){
  const MODELS = [
    { id:"KL3468", label:"KL3468 (8× AI 0–10V)",  fc:4, channels:8, wordsPerCh:2, interleaved:true,  dataOffset:1, statusOffset:0, bitBased:false },
    { id:"KL3208", label:"KL3208 (8× AI temp)",   fc:4, channels:8, wordsPerCh:2, interleaved:true,  dataOffset:1, statusOffset:0, bitBased:false },
    { id:"KL1808", label:"KL1808 (8× DI)",        fc:2, channels:8, wordsPerCh:1, interleaved:false, dataOffset:0, statusOffset:null, bitBased:true  },
    { id:"KL3464", label:"KL3464 (4× AI 0–10V)",  fc:4, channels:4, wordsPerCh:2, interleaved:true,  dataOffset:1, statusOffset:0, bitBased:false },
    { id:"KL3204", label:"KL3204 (4× AI temp)",   fc:4, channels:4, wordsPerCh:2, interleaved:true,  dataOffset:1, statusOffset:0, bitBased:false }
  ];
  const modelMap = Object.fromEntries(MODELS.map(m => [m.id, m]));
  function modelSelectHTML(selId){
    return `<select id="${selId}" style="width:100%">
      ${MODELS.map(m => `<option value="${m.id}">${m.label}</option>`).join("")}
    </select>`;
  }

  RED.nodes.registerType('beckhoff-rack', {
    category: 'Beckhoff',
    color: '#E8F0FE',
    icon: 'font-awesome/fa-server',
    paletteLabel: 'Beckhoff Rack',
    defaults: {
      name:         { value: "" },
      unitId:       { value: 1, validate: RED.validators.number() },
      rackBase:     { value: 0, validate: RED.validators.number() },
      layout:       { value: [] },                // [{model:"KL3468"}, ...]
      outputsCount: { value: 1, validate: RED.validators.number() } // for dynamic outputs
    },
    inputs: 1,
    outputs: function(){                          // dynamic ports
      return this.outputsCount || (Array.isArray(this.layout) ? this.layout.length : 1) || 1;
    },
    outputLabels: function(i){ return "Slot " + (i+1); },
    label: function(){ return this.name || "Beckhoff Rack"; },

    oneditprepare: function() {
      const node = this;

      $('#node-input-unitId').val(this.unitId ?? 1);
      $('#node-input-rackBase').val(this.rackBase ?? 0);

      const list = $("#rack-list").css({minHeight:"180px"}).editableList({
        addItem: function(row, index, data){
          const model = data && data.model ? data.model : "KL3468";
          const selId = `rack-sel-${Date.now()}-${Math.random().toString(36).slice(2)}`;
          const wrap = $(row);
          wrap.css({display:"flex", gap:"6px", alignItems:"center"});
          wrap.append(`<div style="flex:1">${modelSelectHTML(selId)}</div>`);
          const sel = wrap.find(`#${selId}`);
          sel.val(model);
          // expose getter used on save
          row._getValue = () => ({ model: sel.val() });
        },
        sortable: true,
        removable: true
      });

      // load existing layout
      let existing = [];
      try {
        existing = Array.isArray(node.layout) ? node.layout : JSON.parse(node.layout || "[]");
      } catch {}
      if (existing.length === 0) existing = [{model:"KL3468"}];
      existing.forEach(item => list.editableList('addItem', item));

      function recomputePreview(){
        const unitId = Number($('#node-input-unitId').val() || 1);
        const rackBase = Number($('#node-input-rackBase').val() || 0);

        const items = [];
        list.editableList('items').each(function(_, el){
          if (typeof el._getValue === 'function') items.push(el._getValue());
        });

        let base = rackBase;
        const rows = items.map((it, idx) => {
          const meta = modelMap[it.model] || modelMap["KL3468"];
          const length = meta.channels * meta.wordsPerCh;
          const start = base;
          base += length;
          return {
            slot: idx+1, model: it.model, unitId,
            fc: meta.fc, start, length,
            channels: meta.channels, wordsPerCh: meta.wordsPerCh,
            interleaved: meta.interleaved, bitBased: meta.bitBased,
            dataOffset: meta.dataOffset, statusOffset: meta.statusOffset
          };
        });

        // show a plain text preview
        const pre = rows.map(r => `#${r.slot} ${r.model}: start=${r.start}, len=${r.length}, FC=${r.fc}`).join('\n');
        $("#rack-preview").val(pre);

        // update ports preview count (informational)
        $("#rack-portcount").text(rows.length);
      }

      $("#node-input-unitId, #node-input-rackBase").on("change keyup", recomputePreview);
      $("#rack-list").on("change", "select", recomputePreview);
      list.on('change', recomputePreview);
      setTimeout(recomputePreview, 0);

      // buttons to add common terminals
      $("#rack-add-kl3468").on('click', () => list.editableList('addItem', {model:"KL3468"}));
      $("#rack-add-kl3208").on('click', () => list.editableList('addItem', {model:"KL3208"}));
      $("#rack-add-kl1808").on('click', () => list.editableList('addItem', {model:"KL1808"}));
      $("#rack-add-kl3464").on('click', () => list.editableList('addItem', {model:"KL3464"}));
      $("#rack-add-kl3204").on('click', () => list.editableList('addItem', {model:"KL3204"}));

      this.oneditsave = function(){
        const items = [];
        list.editableList('items').each(function(_, el){
          if (typeof el._getValue === 'function') items.push(el._getValue());
        });
        // write to hidden fields so Node-RED persists them
        $("#node-input-layout").val(JSON.stringify(items));
        $("#node-input-outputsCount").val(items.length || 1);
      };
    }
  });
})();
</script>

<script type="text/x-red" data-template-name="beckhoff-rack">
  <div class="form-row">
    <label for="node-input-name">Name</label>
    <input type="text" id="node-input-name" placeholder="BK9100 Rack">
  </div>
  <div class="form-row">
    <label for="node-input-unitId">Unit ID</label>
    <input type="number" id="node-input-unitId" min="1" step="1">
  </div>
  <div class="form-row">
    <label for="node-input-rackBase">Rack base offset</label>
    <input type="number" id="node-input-rackBase" min="0" step="1" placeholder="0">
  </div>

  <hr/>
  <div class="form-row">
    <label>Terminals (in order)</label>
    <ol id="rack-list"></ol>
  </div>
  <div class="form-row">
    <label>&nbsp;</label>
    <div>
      <button type="button" id="rack-add-kl3468">+ KL3468</button>
      <button type="button" id="rack-add-kl3208">+ KL3208</button>
      <button type="button" id="rack-add-kl1808">+ KL1808</button>
      <button type="button" id="rack-add-kl3464">+ KL3464</button>
      <button type="button" id="rack-add-kl3204">+ KL3204</button>
      <span style="margin-left:12px;color:#777">Outputs on deploy: <b id="rack-portcount">1</b></span>
    </div>
  </div>

  <div class="form-row">
    <label>Preview</label>
    <textarea id="rack-preview" style="width:100%; height:120px" readonly></textarea>
  </div>

  <!-- hidden fields that Node-RED persists -->
  <input type="hidden" id="node-input-layout">
  <input type="hidden" id="node-input-outputsCount">
</script>

<script type="text/x-red" data-help-name="beckhoff-rack">
  <p>Describe the physical order of terminals on your BK9100. This node computes per-slot <code>start</code>, <code>length</code> and <code>fc</code> and emits one object per output.</p>
  <p><b>Output (per port):</b> <code>payload = { slot, model, unitId, fc, start, length, channels, wordsPerCh, interleaved, bitBased, dataOffset, statusOffset }</code></p>
  <p>Re-emits on input (any message).</p>
</script>
