<script type="text/javascript">
RED.nodes.registerType('BK9100', {
    category: 'Beckhoff',             // <-- its own palette section
    color: '#C7E9FF',
    paletteLabel: 'BK9100 Router',
    defaults: {
        name:  { value: "" },
        cards: { value: [] }          // [{type,label,filter}]
    },
    inputs: 1,
    // Editor-live & runtime-safe dynamic outputs:
    outputs: function () {
        return Math.max(1, (this.cards && this.cards.length) ? this.cards.length : 1);
    },
    outputLabels: function (index) {
        const c = (this.cards || [])[index];
        return c ? (c.label || c.type || `Out ${index+1}`) : `Out ${index+1}`;
    },
    icon: "bridge.svg",
    label: function () { return this.name || "BK9100"; },

    oneditprepare: function () {
        const node = this;

        // Hidden field so the UI updates port count instantly (like switch node)
        // (Putting it directly in the template below ensures NR picks it up.)
        function setOutputs(n){ $("#node-input-outputs").val(Math.max(1,n)).trigger("change"); }

        function recomputeOutputs() {
            const n = $("#bk-cards").editableList('items').length;
            setOutputs(n);
        }

        $("#bk-cards").editableList({
            addItem: function (container, index, data) {
                const row = $('<div class="form-row" style="display:flex;gap:8px;align-items:center;"></div>').appendTo(container);

                const typeSel = $('<select/>', { class:"node-input-card-type", style:"width:180px" })
                    .append('<option value="KL1808">KL1808</option>')
                    .append('<option value="KL3208">KL3208</option>')
                    .append('<option value="KL3468">KL3468</option>')
                    .appendTo(row);

                $('<input/>', {
                    class: "node-input-card-label",
                    type: "text",
                    placeholder: "e.g. Inputs A",
                    style: "flex:1"
                }).appendTo(row);

                $('<input/>', {
                    class: "node-input-card-filter",
                    type: "text",
                    placeholder: "Exact, *wildcard*, or /regex/",
                    style: "width:260px"
                }).appendTo(row);

                if (data) {
                    typeSel.val(data.type || "KL1808");
                    row.find(".node-input-card-label").val(data.label || "");
                    row.find(".node-input-card-filter").val(data.filter || "");
                }
                recomputeOutputs();
            },
            removable: true,
            sortable: true,
            height: "auto",
            addButton: "Add card",
            sortItems: recomputeOutputs,
            removeItem: recomputeOutputs,
            addItemBefore: recomputeOutputs
        });

        (node.cards || []).forEach(c => $("#bk-cards").editableList('addItem', c));
        recomputeOutputs();
    },

    oneditsave: function () {
        const items = $("#bk-cards").editableList('items');
        const cards = [];
        items.each(function () {
            const row = $(this);
            cards.push({
                type:  row.find(".node-input-card-type").val() || "",
                label: row.find(".node-input-card-label").val() || "",
                filter:row.find(".node-input-card-filter").val() || ""
            });
        });
        this.cards = cards;
        $("#node-input-outputs").val(Math.max(1, cards.length));
    }
});
</script>

<script type="text/x-red" data-template-name="BK9100">
    <!-- Hidden outputs field so the editor adds/removes ports live -->
    <input type="hidden" id="node-input-outputs">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="BK9100"/>
    </div>

    <div class="form-tips" style="margin-top:8px">
        <b>Routing:</b> <code>msg.topic</code> is matched to each card. A cardâ€™s
        <i>Topic filter</i> supports exact (<code>KL1808</code>), wildcard
        (<code>KL*</code>), or regex (<code>/^KL3\d{3}$/</code>). If empty, it matches the card <b>Type</b>.
        Reorder cards to change output order; outputs follow automatically.
    </div>

    <div class="form-row" style="margin-top:8px">
        <div style="font-weight:600">Cards</div>
        <div id="bk-cards"></div>
    </div>
</script>

<script type="text/x-red" data-help-name="BK9100">
    <p>Routes messages to one of N outputs based on <code>msg.topic</code>.
       Number and order of outputs follow the configured cards.</p>
</script>
