<script type="text/javascript">
RED.nodes.registerType('BK9100', {
    category: 'Beckhoff',
    paletteLabel: 'BK9100',
    color: '#C7E9FF',
    icon: 'bridge.svg',

    defaults: {
        name:    { value: "" },
        cards:   { value: [] },
        outputs: { value: 1 }
    },

    inputs: 1,
    outputs: 1,

    label: function () { return this.name || "BK9100"; },
    outputLabels: function (i) {
        const c = (this.cards || [])[i];
        return c ? (c.label || c.type || `Out ${i+1}`) : `Out ${i+1}`;
    },

    oneditprepare: function () {
        const node = this;

        // ensure the hidden field exists
        if (!$("#node-input-outputs").length) {
            $('<input type="hidden" id="node-input-outputs">').appendTo("#dialog-form");
        }

        function setOutputs(n){
            const v = Math.max(1, n|0);
            $("#node-input-outputs").val(v);
            node.outputs = v;
        }

        function recompute(){
            const n = $("#bk-cards").editableList('items').length;
            setOutputs(n || 1);
        }

        // header
        $("#bk-cards-header").empty().append(
            '<div style="display:flex;gap:6px;padding:0 6px 4px 6px;align-items:center;">' +
            '  <div style="width:160px;font-weight:600;">Type</div>' +
            '  <div style="width:220px;font-weight:600;">Label</div>' +
            '  <div style="flex:1;font-weight:600;">Topic filter</div>' +
            '</div>'
        );

        $("#bk-cards").editableList({
            addItem: function (container, index, data) {
                const row = $('<div class="red-ui-editableList-item-content" ' +
                              'style="display:flex;gap:6px;align-items:center;padding:2px 6px;"></div>')
                             .appendTo(container);

                // TYPE
                const typeWrap = $('<div style="width:160px"></div>').appendTo(row);
                $('<input type="text" class="node-input-card-type" style="width:100%" ' +
                  'placeholder="KL1808 / KL3208 / KL3468">').appendTo(typeWrap);

                // LABEL
                const labelWrap = $('<div style="width:220px"></div>').appendTo(row);
                $('<input type="text" class="node-input-card-label" style="width:100%" ' +
                  'placeholder="e.g. Inputs A">').appendTo(labelWrap);

                // FILTER
                const filterWrap = $('<div style="flex:1"></div>').appendTo(row);
                $('<input type="text" class="node-input-card-filter" style="width:100%" ' +
                  'placeholder="Exact, *wildcard*, or /regex/">').appendTo(filterWrap);

                // populate
                if (data && typeof data === "object") {
                    row.find(".node-input-card-type").val(data.type || "");
                    row.find(".node-input-card-label").val(data.label || "");
                    row.find(".node-input-card-filter").val(data.filter || "");
                }

                // trigger recompute after DOM settles
                setTimeout(recompute, 0);
            },
            removable: true,
            sortable: true,
            height: "auto",
            addButton: "Add card",
            sortItems: recompute,
            removeItem: recompute
        });

        // load saved cards
        let cards = this.cards;
        if (typeof cards === "string") {
            try { cards = JSON.parse(cards); } catch { cards = []; }
        }
        if (Array.isArray(cards) && cards.length) {
            cards.forEach(c => $("#bk-cards").editableList('addItem', c));
        } else {
            // show a single empty row
            $("#bk-cards").editableList('addItem', { type:"KL1808", label:"", filter:"" });
        }
    },

    oneditsave: function () {
        const items = $("#bk-cards").editableList('items');
        const cards = [];
        items.each(function () {
            const row = $(this);
            cards.push({
                type:   row.find(".node-input-card-type").val() || "",
                label:  row.find(".node-input-card-label").val() || "",
                filter: row.find(".node-input-card-filter").val() || ""
            });
        });
        this.cards   = cards;
        const n = Math.max(1, cards.length);
        this.outputs = n;
        $("#node-input-outputs").val(n);
    }
});
</script>

<script type="text/x-red" data-template-name="BK9100">
    <input type="hidden" id="node-input-outputs">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="BK9100">
    </div>

    <div class="form-tips" style="margin-top:8px">
        <b>Routing:</b> <code>msg.topic</code> is matched per card. If a card has a
        <i>Topic filter</i>, it supports exact (<code>KL1808</code>), wildcard (<code>KL*</code>),
        or regex (<code>/^KL3\\d{3}$/</code>). If empty, it matches the card <b>Type</b>.
        Reorder cards to change output order; the number of outputs follows the list.
    </div>

    <div id="bk-cards-header"></div>
    <div class="form-row"><div id="bk-cards"></div></div>
</script>

<script type="text/x-red" data-help-name="BK9100">
    <p>Routes messages to one of N outputs based on <code>msg.topic</code>.
       Outputs = number of configured cards; order matches the list.</p>
</script>