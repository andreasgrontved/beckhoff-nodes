<script type="text/javascript">
RED.nodes.registerType('BK9100', {
    category: 'Beckhoff',
    paletteLabel: 'BK9100',
    color: '#C7E9FF',
    icon: 'bridge.svg',

    defaults: {
        name:    { value: "" },
        cards:   { value: [] },
        outputs: { value: 1 }
    },

    inputs: 1,
    outputs: 1,

    label: function () { return this.name || "BK9100"; },
    outputLabels: function (i) {
        const c = (this.cards || [])[i];
        return c ? (c.label || c.type || `Out ${i+1}`) : `Out ${i+1}`;
    },

    oneditprepare: function () {
        const node = this;

        if (!$("#node-input-outputs").length) {
            $('<input type="hidden" id="node-input-outputs">').appendTo("#dialog-form");
        }

        function setOutputs(n){
            const v = Math.max(1, n|0);
            $("#node-input-outputs").val(v);
            node.outputs = v;
        }

        function recompute(){
            const n = $("#bk-cards").editableList('items').length;
            setOutputs(n || 1);
        }

        // Sensor type options for KL3208
        const sensorOptions = [
            { value: 'pt1000', label: 'Pt1000 (default)' },
            { value: 'ni1000', label: 'Ni1000' },
            { value: 'res_6k', label: 'Resistor 6kΩ' },
            { value: 'res_65k', label: 'Resistor 65kΩ' },
            { value: 'res_655k', label: 'Resistor 655kΩ' },
            { value: 'ntc_1k8', label: 'NTC 1.8kΩ' },
            { value: 'ntc_2k2', label: 'NTC 2.2kΩ' },
            { value: 'ntc_3k', label: 'NTC 3kΩ' },
            { value: 'ntc_5k', label: 'NTC 5kΩ' },
            { value: 'ntc_10k', label: 'NTC 10kΩ' },
            { value: 'ntc_20k', label: 'NTC 20kΩ' },
            { value: 'ntc_100k', label: 'NTC 100kΩ' }
        ];

        // Signal range options for KL3468
        const rangeOptions = [
            { value: '0-10', label: '0-10V' },
            { value: '0.5-10', label: '0.5-10V' },
            { value: '2-10', label: '2-10V' }
        ];

        // Manufacturer options for KL3468
        const manufacturerOptions = [
            { value: 'generic', label: 'Generic' },
            { value: 'belimo', label: 'Belimo' }
        ];

        function createSensorSelect(value) {
            const select = $('<select class="node-input-sensor-type" style="width:100%"></select>');
            sensorOptions.forEach(opt => {
                select.append(`<option value="${opt.value}">${opt.label}</option>`);
            });
            if (value) select.val(value);
            return select;
        }

        function createRangeSelect(value) {
            const select = $('<select class="node-input-range-type" style="width:100%"></select>');
            rangeOptions.forEach(opt => {
                select.append(`<option value="${opt.value}">${opt.label}</option>`);
            });
            if (value) select.val(value);
            return select;
        }

        function createManufacturerSelect(value) {
            const select = $('<select class="node-input-manufacturer-type" style="width:100%"></select>');
            manufacturerOptions.forEach(opt => {
                select.append(`<option value="${opt.value}">${opt.label}</option>`);
            });
            if (value) select.val(value);
            return select;
        }

        function showKL3208Config(container, config) {
            const configDiv = $('<div class="kl3208-config" style="margin-top:8px;padding:8px;border:1px solid #ddd;border-radius:4px;background:#f9f9f9;"></div>');
            
            const header = $('<div style="display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;"></div>');
            const icon = $('<i class="fa fa-caret-right" style="transition:transform 0.2s;"></i>');
            const title = $('<span style="font-weight:600;">KL3208 Channel Configuration</span>');
            header.append(icon, title);
            configDiv.append(header);
            
            const grid = $('<div class="channel-grid" style="display:none;grid-template-columns:80px 1fr;gap:6px;align-items:center;margin-top:6px;"></div>');
            
            for (let ch = 1; ch <= 8; ch++) {
                grid.append(`<label style="text-align:right;">Ch ${ch}:</label>`);
                const select = createSensorSelect(config?.channels?.[ch-1] || 'pt1000');
                select.attr('data-channel', ch-1);
                grid.append(select);
            }
            
            configDiv.append(grid);
            
            // Toggle collapse/expand
            header.on('click', function() {
                const isVisible = grid.is(':visible');
                grid.toggle(!isVisible);
                icon.css('transform', isVisible ? 'rotate(0deg)' : 'rotate(90deg)');
            });
            
            container.append(configDiv);
        }

        function showKL3468Config(container, config) {
            const configDiv = $('<div class="kl3468-config" style="margin-top:8px;padding:8px;border:1px solid #ddd;border-radius:4px;background:#f9f9f9;"></div>');
            
            const header = $('<div style="display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;"></div>');
            const icon = $('<i class="fa fa-caret-right" style="transition:transform 0.2s;"></i>');
            const title = $('<span style="font-weight:600;">KL3468 Channel Configuration</span>');
            header.append(icon, title);
            configDiv.append(header);
            
            const grid = $('<div class="channel-grid" style="display:none;grid-template-columns:60px 140px 140px;gap:6px;align-items:center;margin-top:6px;"></div>');
            
            for (let ch = 1; ch <= 8; ch++) {
                grid.append(`<label style="text-align:right;">Ch ${ch}:</label>`);
                const rangeSelect = createRangeSelect(config?.channels?.[ch-1]?.range || '0-10');
                rangeSelect.attr('data-channel', ch-1);
                grid.append(rangeSelect);
                
                const mfgSelect = createManufacturerSelect(config?.channels?.[ch-1]?.manufacturer || 'generic');
                mfgSelect.attr('data-channel', ch-1);
                grid.append(mfgSelect);
            }
            
            configDiv.append(grid);
            
            // Toggle collapse/expand
            header.on('click', function() {
                const isVisible = grid.is(':visible');
                grid.toggle(!isVisible);
                icon.css('transform', isVisible ? 'rotate(0deg)' : 'rotate(90deg)');
            });
            
            container.append(configDiv);
        }

        function hideKL3468Config(container) {
            container.find('.kl3468-config').remove();
        }

        $("#bk-cards-header").empty().append(
            '<div style="display:flex;gap:6px;padding:0 6px 4px 6px;align-items:center;">' +
            '  <div style="width:160px;font-weight:600;">Type</div>' +
            '  <div style="width:220px;font-weight:600;">Label</div>' +
            '  <div style="flex:1;font-weight:600;">Topic filter</div>' +
            '</div>'
        );

        $("#bk-cards").editableList({
            addItem: function (container, index, data) {
                const row = $('<div class="red-ui-editableList-item-content" ' +
                              'style="padding:6px;"></div>').appendTo(container);

                const mainRow = $('<div style="display:flex;gap:6px;align-items:center;"></div>').appendTo(row);

                // TYPE
                const typeWrap = $('<div style="width:160px"></div>').appendTo(mainRow);
                const typeInput = $('<input type="text" class="node-input-card-type" style="width:100%" ' +
                  'placeholder="KL1808 / KL3208 / KL3468">').appendTo(typeWrap);

                // LABEL
                const labelWrap = $('<div style="width:220px"></div>').appendTo(mainRow);
                $('<input type="text" class="node-input-card-label" style="width:100%" ' +
                  'placeholder="e.g. Inputs A">').appendTo(labelWrap);

                // FILTER
                const filterWrap = $('<div style="flex:1"></div>').appendTo(mainRow);
                $('<input type="text" class="node-input-card-filter" style="width:100%" ' +
                  'placeholder="Exact, *wildcard*, or /regex/">').appendTo(filterWrap);

                // Config container (for KL3208 specific settings)
                const configContainer = $('<div class="card-config-container"></div>').appendTo(row);

                // Show/hide KL3208 config based on type
                typeInput.on('change keyup', function() {
                    const type = $(this).val().trim().toUpperCase();
                    if (type === 'KL3208') {
                        if (!configContainer.find('.kl3208-config').length) {
                            showKL3208Config(configContainer, data?.config);
                        }
                    } else {
                        hideKL3208Config(configContainer);
                    }
                    
                    if (type === 'KL3468') {
                        if (!configContainer.find('.kl3468-config').length) {
                            showKL3468Config(configContainer, data?.config);
                        }
                    } else {
                        hideKL3468Config(configContainer);
                    }
                });

                // populate
                if (data && typeof data === "object") {
                    typeInput.val(data.type || "");
                    row.find(".node-input-card-label").val(data.label || "");
                    row.find(".node-input-card-filter").val(data.filter || "");
                    
                    // Trigger type check to show config if needed
                    if (data.type && data.type.toUpperCase() === 'KL3208') {
                        showKL3208Config(configContainer, data.config);
                    }
                    if (data.type && data.type.toUpperCase() === 'KL3468') {
                        showKL3468Config(configContainer, data.config);
                    }
                }

                setTimeout(recompute, 0);
            },
            removable: true,
            sortable: true,
            height: "auto",
            addButton: "Add card",
            sortItems: recompute,
            removeItem: recompute
        });

        // load saved cards
        let cards = this.cards;
        if (typeof cards === "string") {
            try { cards = JSON.parse(cards); } catch { cards = []; }
        }
        if (Array.isArray(cards) && cards.length) {
            cards.forEach(c => $("#bk-cards").editableList('addItem', c));
        } else {
            $("#bk-cards").editableList('addItem', { type:"KL1808", label:"", filter:"" });
        }
    },

    oneditsave: function () {
        const items = $("#bk-cards").editableList('items');
        const cards = [];
        items.each(function () {
            const row = $(this);
            const type = row.find(".node-input-card-type").val() || "";
            const card = {
                type:   type,
                label:  row.find(".node-input-card-label").val() || "",
                filter: row.find(".node-input-card-filter").val() || ""
            };
            
            // Save KL3208 channel configuration
            if (type.toUpperCase() === 'KL3208') {
                const channels = [];
                row.find('.node-input-sensor-type').each(function() {
                    channels.push($(this).val());
                });
                if (channels.length === 8) {
                    card.config = { channels };
                }
            }
            
            // Save KL3468 channel configuration
            if (type.toUpperCase() === 'KL3468') {
                const channels = [];
                row.find('.node-input-range-type').each(function() {
                    const ch = $(this).attr('data-channel');
                    const range = $(this).val();
                    const manufacturer = row.find(`.node-input-manufacturer-type[data-channel="${ch}"]`).val();
                    channels.push({ range, manufacturer });
                });
                if (channels.length === 8) {
                    card.config = { channels };
                }
            }
            
            cards.push(card);
        });
        this.cards   = cards;
        const n = Math.max(1, cards.length);
        this.outputs = n;
        $("#node-input-outputs").val(n);
    }
});
</script>

<script type="text/x-red" data-template-name="BK9100">
    <input type="hidden" id="node-input-outputs">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="BK9100">
    </div>

    <div class="form-tips" style="margin-top:8px">
        <b>Routing:</b> <code>msg.topic</code> is matched per card. If a card has a
        <i>Topic filter</i>, it supports exact (<code>KL1808</code>), wildcard (<code>KL*</code>),
        or regex (<code>/^KL3\\d{3}$/</code>). If empty, it matches the card <b>Type</b>.
        Reorder cards to change output order; the number of outputs follows the list.
        <br><b>KL3208:</b> Configure sensor types for each of the 8 channels.
        <br><b>KL3468:</b> Configure voltage range and manufacturer for each of the 8 channels.
    </div>

    <div id="bk-cards-header"></div>
    <div class="form-row"><div id="bk-cards"></div></div>
</script>

<script type="text/x-red" data-help-name="BK9100">
    <p>Routes messages to one of N outputs based on <code>msg.topic</code>.
       Outputs = number of configured cards; order matches the list.</p>
    <p><b>KL1808:</b> 8 digital inputs, outputs boolean values per channel.</p>
    <p><b>KL3208:</b> 8 analog temperature inputs. Configure the sensor type for each channel. 
       The node converts raw Modbus data to temperature readings in both Celsius and Fahrenheit.</p>
    <p><b>KL3468:</b> 8 analog voltage inputs (0-10V). Configure the voltage range and manufacturer 
       for each channel. The node converts to voltage and percentage (0-100%). Supports Belimo 
       adaptation mode detection.</p>
</script>