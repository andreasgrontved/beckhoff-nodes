<script type="text/javascript">
RED.nodes.registerType('BK9100', {
    category: 'Beckhoff',          // <-- its own library section
    paletteLabel: 'BK9100',
    color: '#C7E9FF',
    icon: 'bridge.svg',

    /* ---- editor-stored properties ---- */
    defaults: {
        name:  { value: "" },
        cards: { value: [] },      // [{type,label,filter}]
        outputs: { value: 1 }      // keep NR UI in sync (like floor-heating)
    },

    inputs: 1,
    outputs: 1,                    // will be updated live in oneditprepare

    label: function () { return this.name || 'BK9100'; },
    outputLabels: function (i) {
        const c = (this.cards || [])[i];
        return c ? (c.label || c.type || `Out ${i+1}`) : `Out ${i+1}`;
    },

    oneditprepare: function () {
        const node = this;

        function syncOutputs() {
            const n = $("#bk-cards").editableList('items').length || 1;
            // mirror the pattern from your floor-heating node:
            node.outputs                 = n;
            node.outputsType             = 'num';
            node.defaults.outputs        = { value: n };
            // no hidden #node-input-outputs needed when you set these
        }

        $("#bk-cards").editableList({
            addItem: function (container, index, data) {
                const row = $('<div class="form-row" style="display:flex;gap:8px;align-items:center;"></div>').appendTo(container);

                const typeSel = $('<select/>', { class:"node-input-card-type", style:"width:180px" })
                    .append('<option value="KL1808">KL1808</option>')
                    .append('<option value="KL3208">KL3208</option>')
                    .append('<option value="KL3468">KL3468</option>')
                    .appendTo(row);

                $('<input/>', {
                    class: "node-input-card-label",
                    type: "text",
                    placeholder: "e.g. Inputs A",
                    style: "flex:1"
                }).appendTo(row);

                $('<input/>', {
                    class: "node-input-card-filter",
                    type: "text",
                    placeholder: "Exact, *wildcard*, or /regex/",
                    style: "width:260px"
                }).appendTo(row);

                if (data) {
                    typeSel.val(data.type || "KL1808");
                    row.find(".node-input-card-label").val(data.label || "");
                    row.find(".node-input-card-filter").val(data.filter || "");
                }
            },
            removable: true,
            sortable: true,
            height: "auto",
            addButton: "Add card",
            sortItems: syncOutputs,
            removeItem: syncOutputs,
            addItemBefore: syncOutputs,
            addItem: function(){ syncOutputs(); }
        });

        // load saved cards
        (node.cards || []).forEach(c => $("#bk-cards").editableList('addItem', c));
        syncOutputs();
    },

    oneditsave: function () {
        // collect cards in the current order
        const items = $("#bk-cards").editableList('items');
        const cards = [];
        items.each(function () {
            const row = $(this);
            cards.push({
                type:  row.find(".node-input-card-type").val() || "",
                label: row.find(".node-input-card-label").val() || "",
                filter:row.find(".node-input-card-filter").val() || ""
            });
        });
        this.cards   = cards;
        this.outputs = Math.max(1, cards.length);   // same as your floor-heating pattern
    }
});
</script>

<script type="text/x-red" data-template-name="BK9100">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="BK9100">
    </div>

    <div class="form-tips" style="margin-top:8px">
        <b>Routing:</b> incoming <code>msg.topic</code> is matched per card.
        If a card has a <i>Topic filter</i>, it supports exact (<code>KL1808</code>),
        wildcard (<code>KL*</code>) or regex (<code>/^KL3\d{3}$/</code>). If empty,
        the card matches when <code>msg.topic</code> equals the card <b>Type</b>.
        Reorder cards to change output order; the number of outputs follows the list.
    </div>

    <div class="form-row" style="margin-top:8px">
        <div style="font-weight:600">Cards</div>
        <div id="bk-cards"></div>
    </div>
</script>

<script type="text/x-red" data-help-name="BK9100">
    <p>Routes messages to one of N outputs based on <code>msg.topic</code>.
       Number and order of outputs = number and order of configured cards.</p>
</script>
