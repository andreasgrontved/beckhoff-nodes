<script type="text/javascript">
RED.nodes.registerType('BK9100', {
    category: 'Beckhoff',
    paletteLabel: 'BK9100',
    color: '#C7E9FF',
    icon: 'bridge.svg',

    defaults: {
        name:    { value: "" },
        cards:   { value: [] },     // [{type,label,filter}]
        outputs: { value: 1 }       // persisted port count
    },

    inputs: 1,
    outputs: 1,

    label: function () { return this.name || "BK9100"; },
    outputLabels: function (i) {
        const c = (this.cards || [])[i];
        return c ? (c.label || c.type || `Out ${i+1}`) : `Out ${i+1}`;
    },

    oneditprepare: function () {
        const node = this;

        // ensure hidden field exists (NR persists this on Deploy)
        if (!$("#node-input-outputs").length) {
            $('<input type="hidden" id="node-input-outputs">').appendTo("#dialog-form");
        }

        function setOutputs(n){
            const v = Math.max(1, n|0);
            $("#node-input-outputs").val(v).trigger("change");  // persist
            node.outputs = v;                                   // live preview
            node.defaults.outputs = { value: v };               // reopen-safe
        }

        function recompute(){
            const n = $("#bk-cards").editableList('items').length;
            setOutputs(n || 1);
        }

        // Build header
        const header = $(`
          <div style="display:flex;gap:6px;padding:0 6px 4px 6px;align-items:center;">
            <div style="width:180px;font-weight:600;">Type</div>
            <div style="width:220px;font-weight:600;">Label</div>
            <div style="flex:1;font-weight:600;">Topic filter</div>
          </div>
        `);
        $("#bk-cards-header").empty().append(header);

        // List
        $("#bk-cards").editableList({
            header: false,
            addItem: function (container, index, data) {
                // content row
                const row = $('<div class="red-ui-editableList-item-content" style="display:flex;gap:6px;align-items:center;padding:2px 6px;"></div>')
                    .appendTo(container);

                // TYPE (select)
                const typeWrap = $('<div style="width:180px"></div>').appendTo(row);
                const typeSel = $('<select class="node-input-card-type" style="width:100%"></select>')
                    .append('<option value="KL1808">KL1808</option>')
                    .append('<option value="KL3208">KL3208</option>')
                    .append('<option value="KL3468">KL3468</option>')
                    .appendTo(typeWrap);

                // LABEL
                const labelWrap = $('<div style="width:220px"></div>').appendTo(row);
                const labelInp = $('<input type="text" class="node-input-card-label" style="width:100%" placeholder="e.g. Inputs A">')
                    .appendTo(labelWrap);

                // FILTER
                const filterWrap = $('<div style="flex:1"></div>').appendTo(row);
                const filterInp = $('<input type="text" class="node-input-card-filter" style="width:100%" placeholder="Exact, *wildcard*, or /regex/">')
                    .appendTo(filterWrap);

                // populate values
                if (data && typeof data === "object") {
                    typeSel.val(data.type || "KL1808");
                    labelInp.val(data.label || "");
                    filterInp.val(data.filter || "");
                }

                // Make sure the delete handle keeps the layout
                container.css("overflow", "visible");
            },
            removable: true,
            sortable: true,
            height: "auto",
            addButton: "Add card",
            sortItems: recompute,
            removeItem: recompute,
            addItemBefore: recompute,
            addItem: function(){ recompute(); }
        });

        // Load saved cards (handle stringified edge-case defensively)
        let cards = this.cards;
        if (typeof cards === "string") {
            try { cards = JSON.parse(cards); } catch { cards = []; }
        }
        (cards || []).forEach(c => $("#bk-cards").editableList('addItem', c));

        // If none present, show one empty row so the ports donâ€™t go to zero
        if (!cards || !cards.length) {
            $("#bk-cards").editableList('addItem', { type:"KL1808", label:"", filter:"" });
        }

        // Initialize ports (also sets the hidden output field)
        recompute();
    },

    oneditsave: function () {
        const items = $("#bk-cards").editableList('items');
        const cards = [];
        items.each(function () {
            const row = $(this);
            cards.push({
                type:   row.find(".node-input-card-type").val() || "",
                label:  row.find(".node-input-card-label").val() || "",
                filter: row.find(".node-input-card-filter").val() || ""
            });
        });
        this.cards   = cards;
        const n = Math.max(1, cards.length);
        this.outputs = n;
        $("#node-input-outputs").val(n).trigger("change"); // persist on Deploy
    }
});
</script>

<script type="text/x-red" data-template-name="BK9100">
    <!-- Hidden: Node-RED reads this to keep output count after Deploy -->
    <input type="hidden" id="node-input-outputs">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="BK9100">
    </div>

    <div class="form-tips" style="margin-top:8px">
        <b>Routing:</b> <code>msg.topic</code> is matched per card.
        If a card has a <i>Topic filter</i>, it supports exact (<code>KL1808</code>),
        wildcard (<code>KL*</code>), or regex (<code>/^KL3\\d{3}$/</code>).
        If empty, it matches the card <b>Type</b>. Reorder cards to change output order;
        the number of outputs follows the list.
    </div>

    <div id="bk-cards-header"></div>
    <div class="form-row">
        <div id="bk-cards"></div>
    </div>
</script>

<script type="text/x-red" data-help-name="BK9100">
    <p>Routes messages to one of N outputs based on <code>msg.topic</code>.
       Outputs = number of configured cards; order matches the list.</p>
</script>
