<script type="text/javascript">
RED.nodes.registerType('BK9100', {
    category: 'Beckhoff',
    paletteLabel: 'BK9100',
    color: '#C7E9FF',
    icon: 'bridge.svg',

    defaults: {
        name:    { value: "" },
        host:    { value: "192.168.1.100" },
        port:    { value: 502 },
        unitId:  { value: 1 },
        pollInterval: { value: 1000 },
        cards:   { value: [] },
        outputs: { value: 1 }
    },

    inputs: 1,
    outputs: 1,

    label: function () { 
        return this.name || "BK9100"; 
    },
    
    outputLabels: function (i) {
        const c = (this.cards || [])[i];
        return c ? (c.label || c.type || "Out " + (i+1)) : "Out " + (i+1);
    },

    oneditprepare: function () {
        const node = this;

        if (!$("#node-input-outputs").length) {
            $('<input type="hidden" id="node-input-outputs">').appendTo("#dialog-form");
        }

        function setOutputs(n){
            const v = Math.max(1, n|0);
            $("#node-input-outputs").val(v);
            node.outputs = v;
        }

        function recompute(){
            const n = $("#bk-cards").editableList('items').length;
            setOutputs(n || 1);
        }

        const sensorOptions = [
            { value: 'pt1000', label: 'Pt1000 (default)' },
            { value: 'ni1000', label: 'Ni1000' },
            { value: 'res_6k', label: 'Resistor 6kΩ' },
            { value: 'res_65k', label: 'Resistor 65kΩ' },
            { value: 'res_655k', label: 'Resistor 655kΩ' },
            { value: 'ntc_1k8', label: 'NTC 1.8kΩ' },
            { value: 'ntc_2k2', label: 'NTC 2.2kΩ' },
            { value: 'ntc_3k', label: 'NTC 3kΩ' },
            { value: 'ntc_5k', label: 'NTC 5kΩ' },
            { value: 'ntc_10k', label: 'NTC 10kΩ' },
            { value: 'ntc_20k', label: 'NTC 20kΩ' },
            { value: 'ntc_100k', label: 'NTC 100kΩ' }
        ];

        const rangeOptions = [
            { value: '0-10', label: '0-10V' },
            { value: '0.5-10', label: '0.5-10V' },
            { value: '2-10', label: '2-10V' }
        ];

        const manufacturerOptions = [
            { value: 'generic', label: 'Generic' },
            { value: 'belimo', label: 'Belimo' }
        ];

        function createSensorSelect(value) {
            const select = $('<select class="node-input-sensor-type" style="width:100%"></select>');
            sensorOptions.forEach(function(opt) {
                select.append('<option value="' + opt.value + '">' + opt.label + '</option>');
            });
            if (value) select.val(value);
            return select;
        }

        function createRangeSelect(value) {
            const select = $('<select class="node-input-range-type" style="width:100%"></select>');
            rangeOptions.forEach(function(opt) {
                select.append('<option value="' + opt.value + '">' + opt.label + '</option>');
            });
            if (value) select.val(value);
            return select;
        }

        function createManufacturerSelect(value) {
            const select = $('<select class="node-input-manufacturer-type" style="width:100%"></select>');
            manufacturerOptions.forEach(function(opt) {
                select.append('<option value="' + opt.value + '">' + opt.label + '</option>');
            });
            if (value) select.val(value);
            return select;
        }

        function showKL1808Config(container, config) {
            const configDiv = $('<div class="kl1808-config" style="margin-top:8px;padding:8px;border:1px solid #ddd;border-radius:4px;background:#f9f9f9;"></div>');
            
            const header = $('<div style="display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;"></div>');
            const icon = $('<i class="fa fa-caret-right" style="transition:transform 0.2s;"></i>');
            const title = $('<span style="font-weight:600;">Card Configuration</span>');
            header.append(icon, title);
            configDiv.append(header);
            
            const content = $('<div class="config-content" style="display:none;margin-top:6px;"></div>');
            
            const pollRow = $('<div style="display:flex;gap:6px;align-items:center;"></div>');
            pollRow.append('<label style="font-weight:600;">Poll Rate (ms):</label>');
            const pollInput = $('<input type="number" class="node-input-card-poll" style="width:120px;" placeholder="Use global" min="100" step="100">');
            if (config && config.pollRate) {
                pollInput.val(config.pollRate);
            }
            pollRow.append(pollInput);
            pollRow.append('<span style="color:#666;font-size:0.9em;margin-left:8px;">Leave empty to use global poll rate</span>');
            content.append(pollRow);
            
            configDiv.append(content);
            
            header.on('click', function() {
                const isVisible = content.is(':visible');
                content.toggle(!isVisible);
                icon.css('transform', isVisible ? 'rotate(0deg)' : 'rotate(90deg)');
            });
            
            container.append(configDiv);
        }

        function hideKL1808Config(container) {
            container.find('.kl1808-config').remove();
        }

        function showKL3208Config(container, config) {
            const configDiv = $('<div class="kl3208-config" style="margin-top:8px;padding:8px;border:1px solid #ddd;border-radius:4px;background:#f9f9f9;"></div>');
            
            const header = $('<div style="display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;"></div>');
            const icon = $('<i class="fa fa-caret-right" style="transition:transform 0.2s;"></i>');
            const title = $('<span style="font-weight:600;">Channel Configuration</span>');
            header.append(icon, title);
            configDiv.append(header);
            
            const grid = $('<div class="channel-grid" style="display:none;margin-top:6px;"></div>');
            
            const numChannels = config && config.numChannels ? config.numChannels : 8;
            
            const channelGrid = $('<div style="display:grid;grid-template-columns:100px 1fr;gap:6px;align-items:center;margin-bottom:10px;"></div>');
            for (let ch = 1; ch <= numChannels; ch++) {
                channelGrid.append('<label style="text-align:left;">Channel ' + ch + ':</label>');
                const channelConfig = config && config.channels ? config.channels[ch-1] : 'pt1000';
                const select = createSensorSelect(channelConfig);
                select.attr('data-channel', ch-1);
                channelGrid.append(select);
            }
            grid.append(channelGrid);
            
            const pollRow = $('<div style="display:flex;gap:6px;align-items:center;padding-top:8px;border-top:1px solid #ddd;"></div>');
            pollRow.append('<label style="font-weight:600;">Poll Rate (ms):</label>');
            const pollInput = $('<input type="number" class="node-input-card-poll" style="width:120px;" placeholder="Use global" min="100" step="100">');
            if (config && config.pollRate) {
                pollInput.val(config.pollRate);
            }
            pollRow.append(pollInput);
            pollRow.append('<span style="color:#666;font-size:0.9em;margin-left:8px;">Leave empty to use global poll rate</span>');
            grid.append(pollRow);
            
            grid.attr('data-num-channels', numChannels);
            configDiv.append(grid);
            
            header.on('click', function() {
                const isVisible = grid.is(':visible');
                grid.toggle(!isVisible);
                icon.css('transform', isVisible ? 'rotate(0deg)' : 'rotate(90deg)');
            });
            
            container.append(configDiv);
        }

        function hideKL3208Config(container) {
            container.find('.kl3208-config').remove();
        }

        function showKL3468Config(container, config) {
            const configDiv = $('<div class="kl3468-config" style="margin-top:8px;padding:8px;border:1px solid #ddd;border-radius:4px;background:#f9f9f9;"></div>');
            
            const header = $('<div style="display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;"></div>');
            const icon = $('<i class="fa fa-caret-right" style="transition:transform 0.2s;"></i>');
            const title = $('<span style="font-weight:600;">Channel Configuration</span>');
            header.append(icon, title);
            configDiv.append(header);
            
            const grid = $('<div class="channel-grid" style="display:none;margin-top:6px;"></div>');
            
            const numChannels = config && config.numChannels ? config.numChannels : 8;
            
            const channelGrid = $('<div style="margin-bottom:10px;"></div>');
            for (let ch = 1; ch <= numChannels; ch++) {
                const rowDiv = $('<div style="display:grid;grid-template-columns:100px 1fr 1fr;gap:6px;align-items:center;margin-bottom:4px;"></div>');
                
                rowDiv.append('<label style="text-align:left;">Channel ' + ch + ':</label>');
                
                const channelConfig = config && config.channels && config.channels[ch-1] ? config.channels[ch-1] : {};
                const rangeSelect = createRangeSelect(channelConfig.range || '0-10');
                rangeSelect.attr('data-channel', ch-1);
                rowDiv.append(rangeSelect);
                
                const mfgSelect = createManufacturerSelect(channelConfig.manufacturer || 'generic');
                mfgSelect.attr('data-channel', ch-1);
                rowDiv.append(mfgSelect);
                
                channelGrid.append(rowDiv);
            }
            grid.append(channelGrid);
            
            const pollRow = $('<div style="display:flex;gap:6px;align-items:center;padding-top:8px;border-top:1px solid #ddd;"></div>');
            pollRow.append('<label style="font-weight:600;">Poll Rate (ms):</label>');
            const pollInput = $('<input type="number" class="node-input-card-poll" style="width:120px;" placeholder="Use global" min="100" step="100">');
            if (config && config.pollRate) {
                pollInput.val(config.pollRate);
            }
            pollRow.append(pollInput);
            pollRow.append('<span style="color:#666;font-size:0.9em;margin-left:8px;">Leave empty to use global poll rate</span>');
            grid.append(pollRow);
            
            grid.attr('data-num-channels', numChannels);
            configDiv.append(grid);
            
            header.on('click', function() {
                const isVisible = grid.is(':visible');
                grid.toggle(!isVisible);
                icon.css('transform', isVisible ? 'rotate(0deg)' : 'rotate(90deg)');
            });
            
            container.append(configDiv);
        }

        function hideKL3468Config(container) {
            container.find('.kl3468-config').remove();
        }

        $("#bk-cards-header").empty().append(
            '<div style="display:flex;gap:6px;padding:2px 6px 4px 6px;align-items:center;">' +
            '  <div style="width:40px;"></div>' +
            '  <div style="width:160px;font-weight:600;">Type</div>' +
            '  <div style="width:220px;font-weight:600;">Label</div>' +
            '  <div style="flex:1;font-weight:600;">Topic filter</div>' +
            '  <div style="width:32px;"></div>' +
            '</div>'
        );

        $("#bk-cards").editableList({
            addItem: function (container, index, data) {
                const row = $('<div class="red-ui-editableList-item-content" style="padding:6px;"></div>').appendTo(container);
                const mainRow = $('<div style="display:flex;gap:6px;align-items:center;"></div>').appendTo(row);

                const typeWrap = $('<div style="width:160px"></div>').appendTo(mainRow);
                const typeInput = $('<input type="text" class="node-input-card-type" style="width:100%" placeholder="KL1804/08, KL3204/08, KL3464/68">').appendTo(typeWrap);

                const labelWrap = $('<div style="width:220px"></div>').appendTo(mainRow);
                $('<input type="text" class="node-input-card-label" style="width:100%" placeholder="e.g. Inputs A">').appendTo(labelWrap);

                const filterWrap = $('<div style="flex:1"></div>').appendTo(mainRow);
                $('<input type="text" class="node-input-card-filter" style="width:100%" placeholder="Optional - leave empty to auto-match">').appendTo(filterWrap);

                const configContainer = $('<div class="card-config-container"></div>').appendTo(row);

                typeInput.on('change keyup', function() {
                    const type = $(this).val().trim().toUpperCase();
                    
                    if (type === 'KL1804' || type === 'KL1808') {
                        hideKL3208Config(configContainer);
                        hideKL3468Config(configContainer);
                        if (!configContainer.find('.kl1808-config').length) {
                            const cfg = data && data.config ? data.config : {};
                            showKL1808Config(configContainer, cfg);
                        }
                    } else {
                        hideKL1808Config(configContainer);
                    }
                    
                    if (type === 'KL3204' || type === 'KL3208') {
                        hideKL1808Config(configContainer);
                        hideKL3468Config(configContainer);
                        if (!configContainer.find('.kl3208-config').length) {
                            const numChannels = type === 'KL3204' ? 4 : 8;
                            const cfg = data && data.config ? data.config : {};
                            cfg.numChannels = numChannels;
                            showKL3208Config(configContainer, cfg);
                        }
                    } else {
                        hideKL3208Config(configContainer);
                    }
                    
                    if (type === 'KL3464' || type === 'KL3468') {
                        hideKL1808Config(configContainer);
                        hideKL3208Config(configContainer);
                        if (!configContainer.find('.kl3468-config').length) {
                            const numChannels = type === 'KL3464' ? 4 : 8;
                            const cfg = data && data.config ? data.config : {};
                            cfg.numChannels = numChannels;
                            showKL3468Config(configContainer, cfg);
                        }
                    } else {
                        hideKL3468Config(configContainer);
                    }
                });

                if (data && typeof data === "object") {
                    typeInput.val(data.type || "");
                    row.find(".node-input-card-label").val(data.label || "");
                    row.find(".node-input-card-filter").val(data.filter || "");
                    
                    const cardType = data.type ? data.type.toUpperCase() : "";
                    const pollRateValue = data.pollRate || null;
                    
                    if (cardType === 'KL1804' || cardType === 'KL1808') {
                        showKL1808Config(configContainer, { pollRate: pollRateValue });
                    }
                    else if (cardType === 'KL3204' || cardType === 'KL3208') {
                        const numChannels = cardType === 'KL3204' ? 4 : 8;
                        const cfg = data.config || {};
                        cfg.numChannels = numChannels;
                        cfg.pollRate = pollRateValue;
                        showKL3208Config(configContainer, cfg);
                    }
                    else if (cardType === 'KL3464' || cardType === 'KL3468') {
                        const numChannels = cardType === 'KL3464' ? 4 : 8;
                        const cfg = data.config || {};
                        cfg.numChannels = numChannels;
                        cfg.pollRate = pollRateValue;
                        showKL3468Config(configContainer, cfg);
                    }
                }

                setTimeout(recompute, 0);
            },
            removable: true,
            sortable: true,
            height: "auto",
            addButton: "Add card",
            sortItems: recompute,
            removeItem: recompute
        });

        let cards = this.cards;
        if (typeof cards === "string") {
            try { cards = JSON.parse(cards); } catch(e) { cards = []; }
        }
        if (Array.isArray(cards) && cards.length) {
            cards.forEach(function(c) { 
                $("#bk-cards").editableList('addItem', c); 
            });
        } else {
            $("#bk-cards").editableList('addItem', { type:"KL1808", label:"", filter:"" });
        }
    },

    oneditsave: function () {
        const items = $("#bk-cards").editableList('items');
        const cards = [];
        items.each(function () {
            const row = $(this);
            const type = row.find(".node-input-card-type").val() || "";
            const pollRateInput = row.find(".node-input-card-poll").val();
            const pollRate = pollRateInput ? parseInt(pollRateInput) : null;
            
            const card = {
                type:   type,
                label:  row.find(".node-input-card-label").val() || "",
                pollRate: pollRate,
                filter: row.find(".node-input-card-filter").val() || ""
            };
            
            if (type.toUpperCase() === 'KL3204' || type.toUpperCase() === 'KL3208') {
                const channels = [];
                row.find('.node-input-sensor-type').each(function() {
                    channels.push($(this).val());
                });
                if (channels.length > 0) {
                    card.config = { channels: channels };
                }
            }
            
            if (type.toUpperCase() === 'KL3464' || type.toUpperCase() === 'KL3468') {
                const channels = [];
                row.find('.node-input-range-type').each(function() {
                    const ch = $(this).attr('data-channel');
                    const range = $(this).val();
                    const manufacturer = row.find('.node-input-manufacturer-type[data-channel="' + ch + '"]').val();
                    channels.push({ range: range, manufacturer: manufacturer });
                });
                if (channels.length > 0) {
                    card.config = { channels: channels };
                }
            }
            
            cards.push(card);
        });
        this.cards = cards;
        const n = Math.max(1, cards.length);
        this.outputs = n;
        $("#node-input-outputs").val(n);
    }
});
</script>

<script type="text/x-red" data-template-name="BK9100">
    <input type="hidden" id="node-input-outputs">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="BK9100">
    </div>

    <hr style="margin: 15px 0;">

    <div class="form-row">
        <label for="node-input-host"><i class="fa fa-globe"></i> IP Address</label>
        <input type="text" id="node-input-host" placeholder="192.168.1.100">
    </div>

    <div class="form-row">
        <label for="node-input-port"><i class="fa fa-plug"></i> Port</label>
        <input type="number" id="node-input-port" placeholder="502" style="width:100px">
    </div>

    <div class="form-row">
        <label for="node-input-unitId"><i class="fa fa-hashtag"></i> Unit ID</label>
        <input type="number" id="node-input-unitId" placeholder="1" style="width:100px">
    </div>

    <div class="form-row">
        <label for="node-input-pollInterval"><i class="fa fa-clock-o"></i> Poll Rate</label>
        <input type="number" id="node-input-pollInterval" placeholder="1000" style="width:100px">
        <span style="margin-left:5px">ms</span>
    </div>

    <hr style="margin: 15px 0;">

    <div class="form-tips" style="margin-top:8px;margin-bottom:12px;">
        <b>Auto-addressing:</b> Cards are polled in order. Addresses auto-calculate based on card position 
        (KL1804=4, KL1808=8, KL3204/KL3464=8, KL3208/KL3468=16 addresses). 
        Reorder cards to match physical BK9100 configuration.
        <br><b>Poll Rate:</b> Set individual poll rates per card (in milliseconds). Leave empty to use global poll rate. 
        Example: Digital inputs=100ms, Temperature=5000ms.
        <br><b>Temperature cards (KL3204/KL3208):</b> Configure sensor types for each channel.
        <br><b>Voltage cards (KL3464/KL3468):</b> Configure voltage range and manufacturer for each channel.
    </div>

    <div id="bk-cards-header"></div>
    <div class="form-row"><div id="bk-cards"></div></div>
</script>

<script type="text/x-red" data-help-name="BK9100">
    <p>Polls Beckhoff BK9100 bus coupler via Modbus TCP and routes data to outputs based on card configuration.</p>
    <p><b>KL1804/KL1808:</b> Digital inputs (4 or 8 channels), outputs boolean values per channel.</p>
    <p><b>KL3204/KL3208:</b> Analog temperature inputs (4 or 8 channels). Configure the sensor type for each channel. 
       The node converts raw Modbus data to temperature readings in both Celsius and Fahrenheit.</p>
    <p><b>KL3464/KL3468:</b> Analog voltage inputs 0-10V (4 or 8 channels). Configure the voltage range and manufacturer 
       for each channel. The node converts to voltage and percentage (0-100%). Supports Belimo 
       adaptation mode detection.</p>
</script>