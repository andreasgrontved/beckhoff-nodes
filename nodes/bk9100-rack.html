<script type="text/javascript">
(function(){

  // --- constants shared with KL3208 original ---
  const SENSOR_OPTIONS = [
    {v:"NTC10-K20K", t:"NTC10K-20K (−40…125°C)"},
    {v:"PT1000",     t:"PT1000 (−50…200°C)"},
    {v:"PT100",      t:"PT100  (−200…850°C)"},
    {v:"CUSTOM",     t:"Custom (set min/max °C)"}
  ];

  function channelRow(i, s, sMin, sMax){
    const idx = i+1;
    const opts = SENSOR_OPTIONS.map(o => `<option value="${o.v}" ${s===o.v?"selected":""}>${o.t}</option>`).join("");
    const customShow = (s === "CUSTOM") ? "" : 'style="display:none"';
    return `
      <div class="form-row kl3208-ch">
        <label>CH ${idx}</label>
        <select class="ch-sel" data-ix="${idx}">
          ${opts}
        </select>
        <span class="custom-wrap" ${customShow}>
          <label style="margin-left:8px">Min °C</label>
          <input type="number" class="ch-min" data-ix="${idx}" value="${sMin ?? ""}">
          <label style="margin-left:8px">Max °C</label>
          <input type="number" class="ch-max" data-ix="${idx}" value="${sMax ?? ""}">
        </span>
      </div>
    `;
  }

  function renderKL3208Card($container, card){
    $container.empty();

    // Register/pattern are fixed for KL3208 typical usage
    const reg = card.register || "input-registers";
    const pattern = card.pattern || "interleaved-status-data";
    const channels = 8;
    let wordsPerChannel = 2; // status+data typical

    $container.append(`
      <div class="form-row">
        <label>Register</label>
        <select class="kl-reg">
          <option value="input-registers" ${reg==="input-registers"?"selected":""}>Input Registers (FC4)</option>
          <option value="holding-registers" ${reg==="holding-registers"?"selected":""}>Holding Registers (FC3)</option>
        </select>
      </div>
      <div class="form-row">
        <label>Pattern</label>
        <select class="kl-pattern">
          <option value="interleaved-status-data" ${pattern==="interleaved-status-data"?"selected":""}>Interleaved status+data</option>
          <option value="contiguous" ${pattern==="contiguous"?"selected":""}>Contiguous</option>
        </select>
      </div>
    `);

    // Per-channel ranges (exactly like original)
    const s = card.settings || {};
    for (let i=0;i<channels;i++){
      const ix = i+1;
      const sel = s["s"+ix] || "NTC10-K20K";
      const min = s["s"+ix+"min"];
      const max = s["s"+ix+"max"];
      $container.append(channelRow(i, sel, min, max));
    }

    // events
    $container.on("change",".ch-sel", function(){
      const v = $(this).val();
      const ix = Number($(this).attr("data-ix"));
      const $wrap = $(this).closest(".kl3208-ch").find(".custom-wrap");
      if (v === "CUSTOM") $wrap.show(); else $wrap.hide();
    });

    // attach helpers for save
    $container.data("__get__", function(){
      const settings = {};
      for (let i=1;i<=8;i++){
        const v = $container.find(`.ch-sel[data-ix="${i}"]`).val();
        const min = $container.find(`.ch-min[data-ix="${i}"]`).val();
        const max = $container.find(`.ch-max[data-ix="${i}"]`).val();
        settings["s"+i] = v;
        settings["s"+i+"min"] = (v==="CUSTOM" && min !== "") ? Number(min) : null;
        settings["s"+i+"max"] = (v==="CUSTOM" && max !== "") ? Number(max) : null;
      }
      return {
        type: "KL3208",
        channels: 8,
        wordsPerChannel: wordsPerChannel,
        register: $(".kl-reg", $container).val(),
        pattern: $(".kl-pattern", $container).val(),
        settings
      };
    });
  }

  function cardTemplate(i, card){
    return `
      <div class="kl-card" data-index="${i}">
        <div class="form-row">
          <label>#${i+1} Type</label>
          <select class="kl-type">
            <option value="KL3208" selected>KL3208</option>
          </select>
          <label style="margin-left:8px">Label</label>
          <input type="text" class="kl-label" value="${card.label || ""}" placeholder="e.g. Room Temps">
        </div>
        <div class="kl-body"></div>
      </div>
    `;
  }

  function readCards($cardsRoot){
    const items = [];
    $cardsRoot.children(".kl-card").each(function(){
      const $c = $(this);
      const label = $c.find(".kl-label").val();
      const get = $c.find(".kl-body").data("__get__");
      const obj = get ? get() : {};
      items.push(Object.assign({ label }, obj));
    });
    return items;
  }

  function renderCards($cardsRoot, cards){
    $cardsRoot.empty();
    (cards && cards.length ? cards : [{}]).forEach((card, i) => {
      const html = cardTemplate(i, card);
      const $card = $(html);
      $cardsRoot.append($card);
      const $body = $card.find(".kl-body");
      renderKL3208Card($body, card); // only KL3208 for now
    });
  }

  RED.nodes.registerType('BK9100 Rack',{
    category: 'Beckhoff',
    color: '#ffd1f2',
    icon: 'font-awesome/fa-server',
    paletteLabel: 'BK9100 Rack',
    defaults: {
      name: { value: "" },
      modbusHost: { value: "", required: true },
      unitId: { value: 1, validate: RED.validators.number() },
      baseAddress: { value: 0, validate: RED.validators.number() },
      cards: { value: [] }
    },
    inputs: 1,
    outputs: function(){
      const c = this.cards || [];
      return Math.max(1, c.length);
    },
    outputLabels: function(i){
      const c = this.cards || [];
      const it = c[i];
      if (!it) return "Card " + (i+1);
      const label = it.label ? ` — ${it.label}` : "";
      return `${it.type || "KL3208"}${label}`;
    },
    label: function(){ return this.name || "BK9100 Rack"; },

    oneditprepare: function(){
      const cards = Array.isArray(this.cards) ? this.cards : [];
      renderCards($("#bk-cards"), cards);

      $("#bk-add").on("click", function(e){
        e.preventDefault();
        const cur = readCards($("#bk-cards"));
        cur.push({ type:"KL3208", label:"" });
        renderCards($("#bk-cards"), cur);
      });
    },
    oneditsave: function(){
      this.cards = readCards($("#bk-cards"));
    }
  });
})();
</script>

<style>
  .kl-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px; margin-bottom: 10px; background:#fff; }
  .kl-card .form-row > label { min-width: 80px; }
  .kl-body .form-row { margin-top: 6px; }
</style>

<script type="text/x-red" data-template-name="BK9100 Rack">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="BK9100 Rack">
  </div>
  <div class="form-row">
    <label for="node-input-modbusHost"><i class="fa fa-plug"></i> Modbus server IP</label>
    <input type="text" id="node-input-modbusHost" placeholder="192.168.1.10">
  </div>
  <div class="form-row">
    <label for="node-input-unitId"><i class="fa fa-hashtag"></i> Unit ID</label>
    <input type="number" id="node-input-unitId" min="1" step="1" placeholder="1">
  </div>
  <div class="form-row">
    <label for="node-input-baseAddress"><i class="fa fa-list-ol"></i> Base address</label>
    <input type="number" id="node-input-baseAddress" min="0" step="1" placeholder="0">
  </div>

  <hr/>
  <div id="bk-cards"></div>
  <div class="form-row">
    <button id="bk-add"><i class="fa fa-plus"></i> Add card (KL3208)</button>
  </div>
</script>

<script type="text/x-red" data-help-name="BK9100 Rack">
  <p><b>BK9100 Rack</b> — Global Modbus settings + ordered list of KL3208 cards.</p>
  <p>On deploy or any input, the node computes each card’s Modbus slice and emits a config message on the matching output.</p>
  <p><b>msg.config passed to KL3208</b> includes:</p>
  <pre>{
  modbus: { host, unitId, register, start, quantity, fc },
  map: { startIndex, step, pattern },
  settings: { s1..s8, s1min..s8min, s1max..s8max }
}</pre>
</script>
